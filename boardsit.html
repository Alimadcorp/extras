<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>GCU Seating Proximity</title>
 <style>
  body {
   background: #121212;
   color: #eee;
   font-family: 'Segoe UI', sans-serif;
   padding: 20px;
   font-size: 14px;
  }
  h2 {
   font-size: 1.8rem;
   margin-bottom: 10px;
   text-align: center;
  }
  .input-container {
   margin: 8px 0;
  }
  input, button {
   padding: 8px 12px;
   margin: 4px;
   width: 240px;
   background: #1e1e1e;
   color: #fff;
   border: 1px solid #333;
   border-radius: 6px;
   font-size: 14px;
  }
  button:hover {
   background: #333;
  }
  .form-section {
   background: #1a1a1a;
   padding: 16px;
   border-radius: 8px;
   max-width: 420px;
   margin: auto;
   border: 1px solid #333;
   margin-bottom: 20px;
  }
  .hidden { display: none; }
  .alert { color: red; }
  #results {
   margin-top: 15px;
   background: #1a1a1a;
   padding: 12px;
   border-radius: 8px;
   border: 1px solid #333;
   max-width: 500px;
   margin-left: auto;
   margin-right: auto;
   line-height: 1.6;
  }
  .own-roll {
   color: #4caf50;
   font-weight: bold;
  }
  .gap-info {
   color: #ff9800;
   font-size: 12px;
  }
 </style>
</head>
<body>

<h2>GCU Seating Proximity</h2>

<div id="uploadSection" class="form-section">
 <div><strong>Upload / Edit Info</strong></div>
 <div class="input-container"><input id="roll" placeholder="College Roll Number"></div>
 <div class="input-container"><input id="name" placeholder="Your Name"></div>
 <div class="input-container"><input id="f_name" placeholder="Father's Name"></div>
 <div class="input-container"><input id="major" placeholder="Major"></div>
 <div class="input-container"><input id="boardRn" placeholder="Board Roll Number" type="number"></div>
 <button id="upload">Upload / Update Info</button>
 <p class="alert" id="uploadAlert"></p>
</div>

<div id="mainSection" class="form-section hidden">
 <div><strong>Find Nearby Students</strong></div>
 <div class="input-container"><input id="searchBoardRn" placeholder="Enter Board Roll Number" type="number"></div>
 <button id="findNearby">Find Closest</button>
 <div id="results"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const config = {
 apiKey: "AIzaSyCH5fSm8L2-OttClhOiFGJmoNB_GLYkdhk",
 authDomain: "survey-75c3c.firebaseapp.com",
 projectId: "survey-75c3c",
 storageBucket: "survey-75c3c.appspot.com",
 messagingSenderId: "607873827800",
 appId: "1:607873827800:web:7ec77a638d0c28c11128ad",
 databaseURL: "https://survey-75c3c-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app = initializeApp(config);
const db = getDatabase(app);
const $ = id => document.getElementById(id);

let uploaded = localStorage.getItem("uploaded") === "true";
let myRoll = localStorage.getItem("myRoll") || "";

if (uploaded) {
 $("uploadSection").classList.remove("hidden");
 $("mainSection").classList.remove("hidden");
 $("roll").value = myRoll;
 $("searchBoardRn").value = localStorage.getItem("myBoard") || "";
 loadOwnData();
}

function loadOwnData() {
 get(child(ref(db), "students/" + myRoll)).then(snap => {
  if (!snap.exists()) return;
  const d = snap.val();
  $("name").value = d.name || "";
  $("f_name").value = d.f_name || "";
  $("major").value = d.major || "";
  $("boardRn").value = d.boardRn || "";
 });
}

$("upload").onclick = async () => {
 const roll = $("roll").value.trim();
 const boardRn = parseInt($("boardRn").value);
 const name = $("name").value.trim();
 const fName = $("f_name").value.trim();
 const major = $("major").value.trim();
 if (!roll || !name || !fName || !major || isNaN(boardRn)) {
  $("uploadAlert").innerText = "Fill all fields!";
  return;
 }

 const data = { name, f_name: fName, major, boardRn, uploadDate: Date.now() };

 try {
  await set(ref(db, "students/" + roll), data);
  localStorage.setItem("uploaded", "true");
  localStorage.setItem("myRoll", roll);
  localStorage.setItem("myBoard", boardRn);
  myRoll = roll;
  $("uploadAlert").innerText = "";
  alert("Uploaded successfully!");
  $("mainSection").classList.remove("hidden");
 } catch (e) {
  $("uploadAlert").innerText = "Upload failed.";
 }
};

$("findNearby").onclick = async () => {
 const inputRn = parseInt($("searchBoardRn").value);
 if (isNaN(inputRn)) return alert("Enter valid board roll no.");

 const snap = await get(child(ref(db), "students"));
 if (!snap.exists()) return $("results").innerHTML = "<p>No data found.</p>";

 const data = Object.entries(snap.val())
  .map(([roll, d]) => ({ roll, ...d }))
  .filter(d => d.boardRn && !isNaN(d.boardRn));

 data.sort((a, b) => a.boardRn - b.boardRn);

 const meIndex = data.findIndex(d => d.boardRn === inputRn);
 if (meIndex === -1) return $("results").innerHTML = "<p>Not found in database.</p>";

 const slice = data.slice(Math.max(0, meIndex - 8), meIndex + 9);
 let html = "";

 for (let i = 0; i < slice.length; i++) {
  const curr = slice[i];
  const isMine = curr.roll === myRoll;
  const next = slice[i + 1];
  html += `<p class="${isMine ? "own-roll" : ""}">
   ${curr.boardRn} - ${curr.name} (${curr.f_name}) [${curr.roll}]
  </p>`;
  if (next && next.boardRn - curr.boardRn > 2) {
   html += `<div class="gap-info">Gap of ${next.boardRn - curr.boardRn}</div>`;
  }
 }

 $("results").innerHTML = html || "<p>No nearby students.</p>";
};
</script>
</body>
</html>
